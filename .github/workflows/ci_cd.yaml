name: Stock Prediction CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  PYTHON_VERSION: '3.10'  
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========================================
  # JOB 1: TRAIN -> DVC PUSH -> DOCKER BUILD
  # ========================================
  train_and_version:
    name: 'Train, Version & Build'
    runs-on: ubuntu-latest
    permissions:
      contents: write # Izin untuk commit .dvc file
      packages: write # Izin untuk upload Docker

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. SETUP LINGKUNGAN
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Full Dependencies (Training)
        run: |
          pip install -r requirements.txt
          # Pastikan DVC terinstall (jaga-jaga jika belum ada di requirements.txt)
          pip install dvc dvc-gdrive

      #  SETUP CREDENTIALS 
      - name: ðŸ”‘ Setup Google Drive Credentials
        run: |
          # 1. Tulis secret (User Token) ke file json
          echo '${{ secrets.GDRIVE_CREDENTIALS_DATA }}' > gdrive_user_credentials.json
          
          # 2. Pastikan mode Service Account MATI (agar tidak error quota)
          dvc remote modify --local gdrive_storage --unset gdrive_use_service_account
          
          # 3. Arahkan DVC ke file User Credentials yang baru dibuat
          dvc remote modify --local gdrive_storage gdrive_user_credentials_file gdrive_user_credentials.json

      # 2. TRAINING 
      - name: ðŸš€ Run Training Pipeline (Main Flow)
        env:
          PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}
          PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          python src/main_flow.py

      # 3. DVC PUSH (Simpan Hasil Training)
      - name: ðŸ“¤ Version & Push to DVC
        run: |
          # Add file yang baru saja digenerate oleh script python
          dvc add data/raw/stock_data.csv models/
          dvc push

      # 4. GIT COMMIT (Update Metadata DVC)
      - name: ðŸ’¾ Commit New DVC Metadata
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/raw/stock_data.csv.dvc models.dvc
          # Commit dengan [skip ci] agar tidak looping terus menerus
          git diff --staged --quiet || git commit -m "ðŸ¤– CI: Update data & models version [skip ci]"
          git push origin main || echo "No changes to push"

      # 5. DOCKER BUILD (Simpan Image Project)
      - name: ðŸ”¡ Lowercase Repo Name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: ðŸ³ Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
  # ========================================
  # JOB 2: PULL FROM DVC -> DEPLOY
  # ========================================
  deploy_production:
    name: 'Deploy to Vercel'
    runs-on: ubuntu-latest
    needs: train_and_version # Tunggu training & upload selesai
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # Kita install DVC saja di sini untuk ambil data
      - name: ðŸ Setup Python & DVC
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Install DVC
        run: pip install dvc dvc-gdrive

      #  SETUP CREDENTIALS (USER MODE)
      - name: ðŸ”‘ Setup Google Drive Credentials (Again)
        run: |
          echo '${{ secrets.GDRIVE_CREDENTIALS_DATA }}' > gdrive_user_credentials.json
          dvc remote modify --local gdrive_storage --unset gdrive_use_service_account
          dvc remote modify --local gdrive_storage gdrive_user_credentials_file gdrive_user_credentials.json

      # 6. PULL DARI DVC
      - name: ðŸ“¥ Pull Models & Data from DVC
        run: |
          dvc pull models.dvc data/raw/stock_data.csv.dvc

      # 7. CLEANUP & PREPARE (INI PERUBAHANNYA)
      - name: ðŸ§¹ Cleanup & Prepare Requirements
        run: |
          # 1. Hapus file kredensial dan folder DVC (Wajib)
          rm -rf .dvc gdrive_user_credentials.json
          
          # 2. Hapus requirements.txt bawaan (yang untuk training)
          rm requirements.txt
          
          # 3. Ganti nama 'requirements-deploy.txt' jadi 'requirements.txt'
          # Agar Vercel otomatis membacanya tanpa konfigurasi aneh-aneh
          mv requirements-deploy.txt requirements.txt

      # 8. DEPLOY
      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          vercel-version: 'latest' 